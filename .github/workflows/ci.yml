name: CI

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Checlout
      uses: actions/checkout@v3
    - name: Build the docker images
      run: docker-compose build api
    - name: Run the stack
      env:
        QUESTMASTER_DB_PASSWORD: ${{ secrets.QUESTMASTER_DB_PASSWORD }}
      run: docker-compose up -d
    - name: Ensure API is running
      run:  "sleep 10 && curl -s -X 'GET' 'http://localhost:8000/health' -H 'accept: application/json'"
    - name: Run tests
      run: docker exec -t questmaster_api_1  npm run test
    - name: Stop the stack
      run: docker-compose down
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      