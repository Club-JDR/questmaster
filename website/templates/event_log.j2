{% extends "base.j2" %}

{% block content %}
<div class="container mt-4">
  <h1 class="text-center"><i class="bi bi-journal-text"></i> Journal d'Événements</h1>

  <div class="container text-center pt-4">
    <!-- Filter Form -->
    <form method="get" class="row g-3 mb-4">
      <div class="col-md-3">
        <label for="user_id" class="form-label">User</label>
        <select name="user_id" id="user_id" class="form-select">
          <option value="">All</option>
          <option value="system" {% if filters.user_id=='system' %}selected{% endif %}>System</option>
          {% for user in users %}
          <option value="{{ user.id }}" {% if filters.user_id==user.id %}selected{% endif %}>
            {{ user.id }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="action" class="form-label">Action</label>
        <select name="action" id="action" class="form-select">
          <option value="">All</option>
          {% for action in event_actions %}
          <option value="{{ action }}" {% if filters.action==action %}selected{% endif %}>{{ action }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="target_type" class="form-label">Target Type</label>
        <select name="target_type" id="target_type" class="form-select">
          <option value="">All</option>
          {% for t in target_types %}
          <option value="{{ t }}" {% if filters.target_type==t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="target_id" class="form-label">Target ID</label>
        <input type="number" name="target_id" id="target_id" value="{{ filters.target_id or '' }}" class="form-control">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filtrer</button>
      </div>
    </form>

    <!-- Event Log Table -->
    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Time</th>
            <th scope="col">User</th>
            <th scope="col">Subject User</th>
            <th scope="col">Action</th>
            <th scope="col">Target</th>
            <th scope="col">Description</th>
          </tr>
        </thead>
        <tbody>
          {% for event in events %}
          <tr>
            <td>{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>{{ event.user.id if event.user else 'System' }}</td>
            <td>{{ event.subject_user.id }}</td>
            <td>{{ event.action }}</td>
            <td>{{ event.target_type }} #{{ event.target_id }}</td>
            <td>{{ event.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link"
            href="{{ url_for('admin_misc.admin_events', page=pagination.prev_num, **filters) }}">Précédent</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Précédent</span>
        </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ pagination.page }} sur {{ pagination.pages }}</span>
        </li>

        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="{{ url_for('admin_misc.admin_events', page=pagination.next_num, **filters) }}">Suivant</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Suivant</span>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}